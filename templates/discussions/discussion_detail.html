{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}{{ discussion.title }}{% endblock %}

{% block content %}
<div class="card mb-4">
    <div class="card-body">
        <h1 class="card-title text-success">{{ discussion.title }}</h1>
        <p class="card-text">{{ discussion.content }}</p>
        <p class="card-subtitle mb-2 text-muted small">
            Posted by {{ discussion.author.username }} on {{ discussion.created_at|date:"M d, Y H:i" }}
        </p>

        {% if attachments %}
            <hr>
            <h3 class="h5 mb-3 text-muted">Attachments:</h3>
            <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3 mb-4">
                {% for attachment in attachments %}
                    <div class="col">
                        <div class="card h-100 bg-light border-0 shadow-sm">
                            <div class="card-body p-3">
                                {% if attachment.image %}
                                    <img src="{{ attachment.image.url }}" alt="{{ attachment.description|default:'Attachment image' }}" class="img-fluid rounded mb-2">
                                {% elif attachment.file %}
                                    <p class="card-text text-primary small">
                                        <a href="{{ attachment.file.url }}" target="_blank" class="text-decoration-none d-block text-truncate">
                                            <i class="bi bi-file-earmark"></i> Download: {{ attachment.file.name|cut:"attachments/files/" }}
                                        </a>
                                    </p>
                                {% endif %}
                                {% if attachment.description %}
                                    <p class="card-text small text-muted mt-1">{{ attachment.description }}</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    </div>
</div>

<h2 class="mb-3 text-success">Comments</h2>

<div id="comments-container">
    {% for comment in comments %}
        <div class="card mb-3 comment-item {% if comment.is_flagged %}flagged-comment{% endif %}" id="comment-{{ comment.id }}">
            <div class="card-body">
                <p class="card-text">{{ comment.content }}</p>
                <div class="d-flex justify-content-between align-items-center small text-muted">
                    <span>By {{ comment.author.username }} on {{ comment.created_at|date:"M d, Y H:i" }}</span>
                    {% if comment.is_flagged %}
                        <span class="badge bg-warning text-dark">Flagged!</span>
                    {% endif %}
                </div>
                {% if comment.is_flagged and comment.flag_reason %}
                    <p class="flag-reason mt-1 mb-0">Reason: {{ comment.flag_reason }}</p>
                {% endif %}

                {% if comment.attachments %}
                    <div class="mt-3 pt-3 border-top border-light">
                        <h4 class="h6 mb-2 text-muted">Comment Attachments:</h4>
                        <div class="row row-cols-1 row-cols-sm-2 g-2">
                            {% for attachment in comment.attachments.all %}
                                <div class="col">
                                    <div class="card bg-light border-0 shadow-sm">
                                        <div class="card-body p-2">
                                            {% if attachment.image %}
                                                <img src="{{ attachment.image.url }}" alt="{{ attachment.description|default:'Comment attachment image' }}" class="img-fluid rounded mb-1">
                                            {% elif attachment.file %}
                                                <p class="card-text text-primary small">
                                                    <a href="{{ attachment.file.url }}" target="_blank" class="text-decoration-none d-block text-truncate">
                                                        <i class="bi bi-file-earmark"></i> Download: {{ attachment.file.name|cut:"attachments/files/" }}
                                                    </a>
                                                </p>
                                            {% endif %}
                                            {% if attachment.description %}
                                                <p class="card-text small text-muted mt-1">{{ attachment.description }}</p>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    {% empty %}
        <div class="alert alert-info" role="alert" id="no-comments-message">
            No comments yet. Be the first to reply!
        </div>
    {% endfor %}
</div>

{% if user.is_authenticated %}
    <div class="card mt-4 mb-5">
        <div class="card-body">
            <h3 class="h4 mb-3 text-success">Add a Comment</h3>
            <form method="post" enctype="multipart/form-data">
                {% csrf_token %}
                {{ comment_form|crispy }} {# Use crispy filter here #}
                <button type="submit" class="btn btn-success mt-3">Post Comment</button>
            </form>
        </div>
    </div>
{% else %}
    <div class="alert alert-info mt-4" role="alert">
        Please <a href="{% url 'accounts:login' %}" class="alert-link">log in</a> to add a comment.
    </div>
{% endif %}

<script>
    // Real-time functionality with WebSockets
    const discussionId = {{ discussion.id }};
    const commentsContainer = document.getElementById('comments-container');
    const noCommentsMessage = document.getElementById('no-comments-message');

    // Function to create a comment HTML element (updated for Bootstrap)
    function createCommentElement(comment) {
        const commentDiv = document.createElement('div');
        commentDiv.className = `card mb-3 comment-item ${comment.is_flagged ? 'flagged-comment' : ''}`;
        commentDiv.id = `comment-${comment.id}`;

        let attachmentsHtml = '';
        if (comment.attachments && comment.attachments.length > 0) {
            attachmentsHtml = `
                <div class="mt-3 pt-3 border-top border-light">
                    <h4 class="h6 mb-2 text-muted">Comment Attachments:</h4>
                    <div class="row row-cols-1 row-cols-sm-2 g-2">
            `;
            comment.attachments.forEach(att => {
                attachmentsHtml += `
                    <div class="col">
                        <div class="card bg-light border-0 shadow-sm">
                            <div class="card-body p-2">
                                ${att.image_url ? `<img src="${att.image_url}" alt="${att.description || 'Comment attachment image'}" class="img-fluid rounded mb-1">` : ''}
                                ${att.file_url ? `<p class="card-text text-primary small"><a href="${att.file_url}" target="_blank" class="text-decoration-none d-block text-truncate"><i class="bi bi-file-earmark"></i> Download: ${att.file_url.split('/').pop()}</a></p>` : ''}
                                ${att.description ? `<p class="card-text small text-muted mt-1">${att.description}</p>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
            attachmentsHtml += `
                    </div>
                </div>
            `;
        }

        commentDiv.innerHTML = `
            <div class="card-body">
                <p class="card-text">${comment.content}</p>
                <div class="d-flex justify-content-between align-items-center small text-muted">
                    <span>By ${comment.author} on ${comment.created_at}</span>
                    ${comment.is_flagged ? '<span class="badge bg-warning text-dark">Flagged!</span>' : ''}
                </div>
                ${comment.is_flagged && comment.flag_reason ? `<p class="flag-reason mt-1 mb-0">Reason: ${comment.flag_reason}</p>` : ''}
                ${attachmentsHtml}
            </div>
        `;
        return commentDiv;
    }

    // WebSocket connection
    const chatSocket = new WebSocket(
        'ws://' + window.location.host + '/ws/discussions/' + discussionId + '/'
    );

    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        const messageType = data.type;

        if (messageType === 'new_comment_notification') {
            const commentData = data.message;
            const newCommentElement = createCommentElement(commentData);

            // Remove "No comments yet" message if it exists
            if (noCommentsMessage) {
                noCommentsMessage.remove();
            }

            commentsContainer.appendChild(newCommentElement);
            commentsContainer.scrollTop = commentsContainer.scrollHeight; // Scroll to bottom

            // Show a browser notification
            if (Notification.permission === "granted") {
                new Notification(`New comment on "${discussion.title}"`, {
                    body: `${commentData.author}: ${commentData.content.substring(0, 50)}...`,
                    icon: '/static/favicon.ico' // Or a relevant icon
                });
            } else if (Notification.permission !== "denied") {
                Notification.requestPermission().then(permission => {
                    if (permission === "granted") {
                        new Notification(`New comment on "${discussion.title}"`, {
                            body: `${commentData.author}: ${commentData.content.substring(0, 50)}...`,
                            icon: '/static/favicon.ico'
                        });
                    }
                });
            }
        }
    };

    chatSocket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly');
    };

    // Request notification permission on page load
    document.addEventListener('DOMContentLoaded', () => {
        if (!("Notification" in window)) {
            console.warn("This browser does not support desktop notification");
        } else if (Notification.permission !== "granted" && Notification.permission !== "denied") {
            Notification.requestPermission();
        }
    });
</script>
{% endblock %}